---
title: "ColocAnalysis"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{ColocAnalysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(devtools)
load_all()
```

```{r}
gwasFile <- tempfile(pattern = "file")
gwasURL <- "http://bioinfo.szbl.ac.cn/finalColoc/tmp/gwasFile/chr6.txt"
if( file.exists(gwasFile) ){ 
  message("File exists: ",gwasFile)
}else{
  utils::download.file(gwasURL, destfile=gwasFile)
}
# If your dataset provides the standard error, simply square it to get the variance.
gwasDF <- data.table::fread(gwasFile, sep="\t", header=TRUE)

```

```{r}
traitGene="RP11-385F7.1"
tissueSiteDetail="Lung"
geneAsso<-  GTExdownload_assoAll(traitGene, tissueSiteDetail=tissueSiteDetail)
geneAsso <- geneAsso[,c("snpId", "pValue", "maf")]
geneAsso
```

```{r}
# eqtlAsso <- suppressMessages( GTExvisual_eqtlTrait(traitGene, tissueSiteDetail=tissueSiteDetail) )
```

```{r}
gwas_eqtl <- merge(gwasDF[,.(snpId=rsid, pValue=P, maf=maf, position)], geneAsso, by="snpId", sort=FALSE, suffixes = c(".gwas",".eqtl"))
# sentinal snps:
centerSnp <- gwas_eqtl[which.min(gwas_eqtl$pValue.gwas),]
colocRange=1e6
gwas_eqtl <- gwas_eqtl[position>=(centerSnp$position-(colocRange)/2) & position<=(centerSnp$position+(colocRange)/2),]
gwas_eqtl
```

```{r}
library(coloc)
colocResult <- coloc.abf(
  dataset1=list(
    pvalues=gwas_eqtl$pValue.gwas, type="quant", N=50000, MAF=gwas_eqtl$maf.gwas),
 dataset2=list(
   pvalues=gwas_eqtl$pValue.eqtl, type="quant", N=600,
   MAF=gwas_eqtl$maf.gwas))
colocResult
```

```{r}
library(locuscomparer)
suppressWarnings(locuscompare( gwas_eqtl[,.(rsid=snpId, pval=pValue.gwas)], gwas_eqtl[,.(rsid=snpId, pval=pValue.eqtl)] ))

```

```{r}
eqtlAsso2 <-  GTExvisual_eqtlTrait(traitGene, tissueSiteDetail=tissueSiteDetail) 

```
